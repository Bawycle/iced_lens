# SPDX-License-Identifier: CC0-1.0
# Flatpak manifest for IcedLens - Privacy-first media viewer and editor
#
# Build locally:
#   flatpak-builder --force-clean --user build-dir flatpak/page.codeberg.Bawycle.IcedLens.yml
#
# Install locally:
#   flatpak-builder --user --install --force-clean build-dir flatpak/page.codeberg.Bawycle.IcedLens.yml
#
# Run:
#   flatpak run page.codeberg.Bawycle.IcedLens

app-id: page.codeberg.Bawycle.IcedLens
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
command: iced_lens

# Sandbox permissions (minimal set for functionality)
finish-args:
  # Display (Wayland preferred, X11 fallback)
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc

  # GPU access for wgpu/Vulkan rendering (iced GUI)
  - --device=dri

  # Audio playback for video support (cpal/PulseAudio)
  - --socket=pulseaudio

  # Network access for AI model downloads from Hugging Face (optional feature)
  # Models are downloaded on first use and cached locally
  - --share=network

  # XDG directories for media access (pictures, videos, downloads, documents)
  # Using specific directories instead of --filesystem=home for better security
  - --filesystem=xdg-pictures
  - --filesystem=xdg-videos
  - --filesystem=xdg-download
  - --filesystem=xdg-documents

  # Portal access for GTK file dialogs (rfd crate)
  - --talk-name=org.freedesktop.portal.FileChooser

  # System theme detection (dark-light crate)
  - --talk-name=org.freedesktop.portal.Settings

# FFmpeg extension for video decoding (libavcodec, libavformat, etc.)
add-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    version: '24.08'
    directory: lib/ffmpeg
    add-ld-path: .
    autodelete: false
    no-autodownload: false

# Build modules
modules:
  # Module 1: ONNX Runtime library (per-architecture)
  # Required for AI features (upscaling, deblurring)
  # Version must match ort crate requirements (v1.23.2 for ort 2.0.0-rc.10)
  - name: onnxruntime
    buildsystem: simple
    build-commands:
      - install -Dm755 lib/libonnxruntime.so.1.23.2 /app/lib/libonnxruntime.so.1.23.2
      - ln -sf libonnxruntime.so.1.23.2 /app/lib/libonnxruntime.so
    sources:
      # x86_64 architecture
      - type: archive
        only-arches:
          - x86_64
        url: https://github.com/microsoft/onnxruntime/releases/download/v1.23.2/onnxruntime-linux-x64-1.23.2.tgz
        sha256: 1fa4dcaef22f6f7d5cd81b28c2800414350c10116f5fdd46a2160082551c5f9b

      # aarch64 architecture
      - type: archive
        only-arches:
          - aarch64
        url: https://github.com/microsoft/onnxruntime/releases/download/v1.23.2/onnxruntime-linux-aarch64-1.23.2.tgz
        sha256: 7c63c73560ed76b1fac6cff8204ffe34fe180e70d6582b5332ec094810241e5c

  # Module 2: IcedLens application
  - name: iced_lens
    buildsystem: simple
    build-options:
      # Add Rust toolchain to PATH
      append-path: /usr/lib/sdk/rust-stable/bin

      # Cargo environment for offline build (Flathub requirement)
      env:
        CARGO_HOME: /run/build/iced_lens/cargo
        CARGO_NET_OFFLINE: 'true'
        # Tell ort crate to use system ONNX Runtime
        ORT_STRATEGY: system
        ORT_LIB_LOCATION: /app/lib

    build-commands:
      # Create FFmpeg extension mount point
      - install -d /app/lib/ffmpeg

      # Build release binary (offline mode with vendored dependencies)
      - cargo --offline fetch --manifest-path Cargo.toml --locked
      - cargo --offline build --release --locked

      # Install binary
      - install -Dm755 target/release/iced_lens /app/bin/iced_lens

      # Install desktop file
      - install -Dm644 flatpak/page.codeberg.Bawycle.IcedLens.desktop /app/share/applications/page.codeberg.Bawycle.IcedLens.desktop

      # Install AppStream metainfo
      - install -Dm644 flatpak/page.codeberg.Bawycle.IcedLens.metainfo.xml /app/share/metainfo/page.codeberg.Bawycle.IcedLens.metainfo.xml

      # Install SVG icon (scalable) - source of truth
      - install -Dm644 assets/branding/iced_lens.svg /app/share/icons/hicolor/scalable/apps/page.codeberg.Bawycle.IcedLens.svg

      # Install PNG icons for better compatibility (generated by build.rs from SVG)
      - install -Dm644 target/branding/iced_lens-64.png /app/share/icons/hicolor/64x64/apps/page.codeberg.Bawycle.IcedLens.png
      - install -Dm644 target/branding/iced_lens-128.png /app/share/icons/hicolor/128x128/apps/page.codeberg.Bawycle.IcedLens.png
      - install -Dm644 target/branding/iced_lens-256.png /app/share/icons/hicolor/256x256/apps/page.codeberg.Bawycle.IcedLens.png

      # Install i18n translation files
      - install -d /app/share/iced_lens/i18n
      - install -Dm644 assets/i18n/en-US.ftl /app/share/iced_lens/i18n/en-US.ftl
      - install -Dm644 assets/i18n/fr.ftl /app/share/iced_lens/i18n/fr.ftl
      - install -Dm644 assets/i18n/es.ftl /app/share/iced_lens/i18n/es.ftl
      - install -Dm644 assets/i18n/de.ftl /app/share/iced_lens/i18n/de.ftl
      - install -Dm644 assets/i18n/it.ftl /app/share/iced_lens/i18n/it.ftl

      # Install license files
      - install -Dm644 LICENSE /app/share/licenses/page.codeberg.Bawycle.IcedLens/LICENSE
      - install -Dm644 ICON_LICENSE.md /app/share/licenses/page.codeberg.Bawycle.IcedLens/ICON_LICENSE.md

    sources:
      # Source code from Git (use specific tag for releases)
      - type: git
        url: https://codeberg.org/Bawycle/iced_lens.git
        # For development builds, use branch; for releases, use tag
        branch: master
        # tag: v0.6.0
        # commit: <commit-hash>

      # Vendored Cargo dependencies (generated by flatpak-cargo-generator)
      # Generate with: python3 flatpak-cargo-generator.py Cargo.lock -o cargo-sources.json
      - cargo-sources.json
